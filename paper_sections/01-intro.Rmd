
# I: Introduction

```{r part_1_premble, include=FALSE}
#### Code for part I: Introduction ####
```
Two of the most popular and powerful modelling techniques currently in use by ecologists are generalized additive models [GAMs; @wood_generalized_2017] for modelling flexible regression functions, and generalized linear mixed models ["hierarchical generalized linear models" (HGLMs) or simply "hierarchical models"; @Bolker:2009cs; @gelman2013bayesian] for modelling between-group variability in regression relationships.

At first glance, GAMs and HGLMs are very different tools used to solve different problems. GAMs are used to estimate smooth functional relationships between predictor variables and the response. HGLMs, on the other hand, are used to estimate linear relationships between predictor variables and response (although nonlinear relationships can also be modeled through quadratic terms or other transformations of the predictor variables), but impose a structure where predictors are organized into groups (often referred to as "blocks") and the relationships between predictor and response may vary across groups. Either the slope or intercept, or both, may be subject to grouping. A typical example of HGLM use might be to include site-specific effects in a model of population counts, or to model individual level heterogeneity in a study with repeated observations of multiple individuals.

However, the connection between HGLMs and GAMs is quite deep, both conceptually and mathematically  [@verbyla_analysis_2002]. HGLMs and GAMs fit highly variable models by "pooling" parameter estimates towards one another, by penalizing squared deviations from some simpler model. In an HGLM, this occurs as group-level effects are pulled towards global effects (penalizing the squared differences between each group-level parameter estimate and the global effect). In a GAM, this occurs via the enforcement of a smoothness criterion on the variability of a functional relationship, pulling parameters towards some function that is assumed to be totally smooth (such as a straight line) by penalizing squared deviations from that totally smooth function.

Given this connection, a natural extension to the standard GAM framework is to allow smooth functional relationships between predictor and response to vary between groups, but in such a way that the different functions are in some sense pooled toward a common shape. We often want to know both how functional relationships vary between groups, and if a relationship holds across groups. We will refer to this type of model as a *hierarchical GAM*, or HGAM.  

There are many potential uses for HGAMs. For example, we can use HGAMs to estimate how the  maximum size of different fish species varies along a common temperature gradient (Fig.  \ref{fig:fish_size}). Each species will typically have its own response function, but since the species overlap in range, they should have similar responses over at least some of the temperature gradient; Figure \ref{fig:fish_size} shows all three species reach their largest maximum sizes in the centre of the temperature gradient. Estimating a separate function for each species throws away a lot of shared information and could result in highly noisy function estimates if there were only a few data points for each species. Estimating a single average relationship could result in a function that did not predict any specific group well. In our example, using a single global temperature-size relationship (Fig. \ref{fig:fish_size}, solid line) would miss that the three species have distinct temperature optima, and that the orange species is significantly smaller at all temperatures than the other two (Fig. \ref{fig:fish_size}). We prefer a hierarchical model that includes a global temperature-size curve plus species-specific curves that were penalized to be close to the mean function.

```{r fish_size, echo=FALSE, message=FALSE,cache=TRUE,purl=FALSE, fig.align='center',fig.cap="\\label{fig:fish_size}Hypothetical example of functional variability between different group levels. Each dashed line indicates how the abundance for different species of fish in a community might vary as a function of average water temperature. The orange species shows lower abundance at all temperatures, and the red and blue species differ at which temperature they can achieve the maximum possible size. However, all three curves are similiarly smooth and peak close to one another relative to the entire range of tested temperatures. The solid black line represents an 'average abundance curve', representing the mean abundance across species in the sample.", messages=FALSE, dev=c('pdf'), out.width=".6\\linewidth"}
knitr::include_graphics('../figures/temp_growth_example.pdf')
```

This paper discusses several approaches to group-level smoothing, and corresponding trade-offs.  We focus on fitting HGAMs with the popular **mgcv** package [@wood_fast_2011] for the R statistical programming language [@r_core_2018],  which allows for a variety of HGAM model structures and fitting strategies. We discuss options available to the modeller and practical and theoretical reasons for choosing them.  We demonstrate the different approaches across a range of case studies.

This paper is divided into five sections. Part II is a brief review of how GAMs work and their relation to hierarchical models. In part III, we discuss different HGAM formulations, what assumptions each model makes about how information is shared between groups, and the different ways of specifying these models in **mgcv**. In part IV, we work through example analyses using this approach, to demonstrate the modelling process and how HGAMs can be incorporated into the ecologist's quantitative toolbox. Finally, in part V, we discuss some of the computational and statistical issues involved in fitting HGAMs in **mgcv**. We have also included all the code needed to reproduce the results in this manuscript in supplemental code (online), and on the GitHub repository associated with this paper: [github.com/eric-pedersen/mixed-effect-gams](http://www.github.com/eric-pedersen/mixed-effect-gams).


